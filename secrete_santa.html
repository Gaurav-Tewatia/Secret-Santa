<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/> 
    <title>Secret Santa Game</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(to bottom right, #f0f4ff, #e2efff);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        header, footer {
            background: #3f51b5;
            color: #fff;
            width: 100%;
            text-align: center;
            padding: 1rem;
        }

        main {
            background: #fff;
            width: 90%;
            max-width: 600px;
            margin: 2rem auto;
            border-radius: 8px;
            box-shadow: 0px 0px 10px rgba(0,0,0,0.1);
            padding: 2rem;
        }

        h1, h2, h3 {
            text-align: center;
            margin-bottom: 1rem;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        input, select, button {
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 1rem;
        }

        button {
            background: #3f51b5;
            color: #fff;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background: #303f9f;
        }

        .results-list {
            list-style-type: none;
            padding: 0;
        }

        .results-list li {
            background: #f9f9f9;
            border-radius: 4px;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .correct {
            background: #d4edda;
            border-left: 5px solid #28a745;
        }

        .wrong {
            background: #f8d7da;
            border-left: 5px solid #dc3545;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .nav-buttons {
            text-align: center;
            margin-top: 2rem;
        }

        .nav-buttons button {
            margin: 0 0.5rem;
        }

        .summary {
            text-align: center;
            margin-bottom: 1rem;
            font-weight: bold;
        }

        /* Leaderboard */
        #leaderboardSection table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        #leaderboardSection th, #leaderboardSection td {
            border: 1px solid #ccc;
            padding: 0.5rem;
            text-align: center;
        }

        #leaderboardSection th {
            background-color: #3f51b5;
            color: #fff;
        }
    </style>
</head>
<body>
    <header>
        <h1>Secret Santa Game</h1>
    </header>
    <main>
        <!-- Guess Section -->
        <section id="guessSection" class="section active">
            <h2>Make Your Guesses</h2>
            <p>Enter your name and up to three names in order of priority (1 = highest priority).</p>
            <form id="guessForm">
                <label>Your Name:
                    <input type="text" id="guesserName" required placeholder="e.g., Alice" />
                </label>
                <label>First Guess (Priority 1 - 30 points if correct):
                    <input type="text" id="guess1" required placeholder="e.g., Bob" />
                </label>
                <label>Second Guess (Priority 2 - 20 points if correct):
                    <input type="text" id="guess2" placeholder="e.g., Carol" />
                </label>
                <label>Third Guess (Priority 3 - 10 points if correct):
                    <input type="text" id="guess3" placeholder="e.g., Dave" />
                </label>
                <button type="submit">Submit Guesses</button>
            </form>
            <div class="nav-buttons">
                <button id="toGiversPage">Done Guessing? Proceed</button>
            </div>
        </section>

        <!-- Givers Section -->
        <section id="giversSection" class="section">
            <h2>Reveal Who You Gave A Gift To</h2>
            <p>Enter your name and the name of the person you gave a gift to.</p>
            <form id="giverForm">
                <label>Your Name:
                    <input type="text" id="giverName" required placeholder="e.g., Bob" />
                </label>
                <label>You Gave A Gift To:
                    <input type="text" id="gaveToName" required placeholder="e.g., Alice" />
                </label>
                <button type="submit">Submit</button>
            </form>
            <div class="nav-buttons">
                <button id="toResultsPage">Done Entering? See Results</button>
            </div>
        </section>

        <!-- Results Section -->
        <section id="resultsSection" class="section">
            <h2>Who Guessed Correctly?</h2>
            <div id="summary" class="summary"></div>
            <ul class="results-list" id="resultsList"></ul>
            <div class="nav-buttons">
                <button id="viewLeaderboard">Leaderboard</button>
                <button id="resetGame">Reset Game</button>
            </div>
        </section>

        <!-- Leaderboard Section -->
        <section id="leaderboardSection" class="section">
            <h2>Leaderboard</h2>
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Score</th>
                    </tr>
                </thead>
                <tbody id="leaderboardTableBody"></tbody>
            </table>
            <div class="nav-buttons">
                <button id="backToResults">Back to Results</button>
            </div>
        </section>
    </main>
    <footer>
        <p>&copy; 2024 Secret Santa</p>
    </footer>

    <!-- Firebase SDKs -->
    <script type="module">
      // Import the Firebase SDK
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-analytics.js";
      import { getFirestore, collection, query, where, getDocs, addDoc, updateDoc, doc, deleteDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

      // Your Firebase config (use your actual config here)
      const firebaseConfig = {
        apiKey: "AIzaSyCudJH7Swrh...",
        authDomain: "secret-santa-game-3ed24.firebaseapp.com",
        projectId: "secret-santa-game-3ed24",
        storageBucket: "secret-santa-game-3ed24.firebasestorage.app",
        messagingSenderId: "691212569555",
        appId: "1:691212569555:web:16ba188f794a2f43617d26",
        measurementId: "G-C0XLZHNGVZ"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app); // Optional
      const db = getFirestore(app);

      // Elements
      const guessSection = document.getElementById('guessSection');
      const giversSection = document.getElementById('giversSection');
      const resultsSection = document.getElementById('resultsSection');
      const leaderboardSection = document.getElementById('leaderboardSection');

      const guessForm = document.getElementById('guessForm');
      const giverForm = document.getElementById('giverForm');
      const resultsList = document.getElementById('resultsList');
      const summaryDiv = document.getElementById('summary');
      const leaderboardTableBody = document.getElementById('leaderboardTableBody');

      const toGiversPageBtn = document.getElementById('toGiversPage');
      const toResultsPageBtn = document.getElementById('toResultsPage');
      const resetGameBtn = document.getElementById('resetGame');
      const viewLeaderboardBtn = document.getElementById('viewLeaderboard');
      const backToResultsBtn = document.getElementById('backToResults');

      function showSection(section) {
          [guessSection, giversSection, resultsSection, leaderboardSection].forEach(sec => {
              sec.classList.remove('active');
          });
          section.classList.add('active');
      }

      // Submit guesses
      guessForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          const name = document.getElementById('guesserName').value.trim();
          const g1 = document.getElementById('guess1').value.trim();
          const g2 = document.getElementById('guess2').value.trim();
          const g3 = document.getElementById('guess3').value.trim();

          if(!name || !g1) return;

          let guessArr = [g1];
          if(g2) guessArr.push(g2);
          if(g3) guessArr.push(g3);

          const guessesRef = collection(db, 'guesses');
          // Check if user already exists
          const q = query(guessesRef, where('name', '==', name));
          const snapshot = await getDocs(q);
          if (!snapshot.empty) {
              for (const docSnap of snapshot.docs) {
                  await updateDoc(doc(db, 'guesses', docSnap.id), { guesses: guessArr });
              }
          } else {
              await addDoc(guessesRef, { name, guesses: guessArr });
          }

          document.getElementById('guesserName').value = '';
          document.getElementById('guess1').value = '';
          document.getElementById('guess2').value = '';
          document.getElementById('guess3').value = '';
          alert("Your guesses have been recorded.");
      });

      toGiversPageBtn.addEventListener('click', function() {
          showSection(giversSection);
      });

      // Submit givers
      giverForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          const name = document.getElementById('giverName').value.trim();
          const gaveTo = document.getElementById('gaveToName').value.trim();

          if(!name || !gaveTo) return;

          const giversRef = collection(db, 'givers');
          const q = query(giversRef, where('name', '==', name));
          const snapshot = await getDocs(q);
          if (!snapshot.empty) {
              for (const docSnap of snapshot.docs) {
                  await updateDoc(doc(db, 'givers', docSnap.id), { gaveTo });
              }
          } else {
              await addDoc(giversRef, { name, gaveTo });
          }

          document.getElementById('giverName').value = '';
          document.getElementById('gaveToName').value = '';
          alert("Giver info recorded.");
      });

      toResultsPageBtn.addEventListener('click', async function() {
          showSection(resultsSection);
          await displayResults();
      });

      async function displayResults() {
          resultsList.innerHTML = '';
          summaryDiv.innerHTML = '';

          const guessesRef = collection(db, 'guesses');
          const giversRef = collection(db, 'givers');

          const guessesSnap = await getDocs(guessesRef);
          const giversSnap = await getDocs(giversRef);

          const guesses = [];
          guessesSnap.forEach(doc => guesses.push(doc.data()));

          const givers = [];
          giversSnap.forEach(doc => givers.push(doc.data()));

          // Map receiver -> giver
          const receiverMap = {};
          givers.forEach(g => {
              receiverMap[g.gaveTo.toLowerCase()] = g.name;
          });

          let correctCount = 0;
          let totalGuesses = guesses.length;
          let scoresMap = {};
          guesses.forEach(g => {
              scoresMap[g.name.toLowerCase()] = 0;
          });

          async function updateScoresStorage() {
              // Persist scores to Firestore in 'scores' collection
              const scoresRef = collection(db, 'scores');
              for (const [key, score] of Object.entries(scoresMap)) {
                  const nameQuery = query(scoresRef, where('name', '==', key));
                  const snap = await getDocs(nameQuery);
                  if (!snap.empty) {
                      for (const docSnap of snap.docs) {
                          // Update only if new score is greater
                          const oldScore = docSnap.data().score || 0;
                          if (score > oldScore) {
                              await updateDoc(doc(db, 'scores', docSnap.id), { score });
                          }
                      }
                  } else {
                      // Add new if no record found
                      await addDoc(scoresRef, { name: key, score });
                  }
              }
          }

          // Helper function to handle a correct guess at a given priority
          async function handleCorrectGuess(li, guessObj, userGuess, priorityScore) {
              li.classList.remove('wrong');
              li.classList.add('correct');
              li.textContent += `Correct on priority ${priorityScore === 30 ? 1 : priorityScore === 20 ? 2 : 3} guess!`;
              scoresMap[guessObj.name.toLowerCase()] = priorityScore;
              correctCount++;
              await updateScoresStorage();
          }

          for (const guessObj of guesses) {
              const li = document.createElement('li');
              const actualGiver = receiverMap[guessObj.name.toLowerCase()] || "Unknown";
              const userGuesses = guessObj.guesses || [];

              // Check first guess
              if (userGuesses[0] && userGuesses[0].toLowerCase() === actualGiver.toLowerCase()) {
                  li.classList.add('correct');
                  li.textContent = `${guessObj.name} guessed ${userGuesses[0]} (first priority) correctly!`;
                  scoresMap[guessObj.name.toLowerCase()] = 30;
                  correctCount++;
                  await updateScoresStorage();
              } else {
                  // First guess wrong
                  li.classList.add('wrong');
                  li.textContent = `${guessObj.name} guessed ${userGuesses[0]} which is incorrect. `;

                  if (userGuesses[1]) {
                      const revealSecondBtn = document.createElement('button');
                      revealSecondBtn.textContent = 'Reveal Second Guess';
                      revealSecondBtn.style.marginLeft = '0.5rem';
                      revealSecondBtn.addEventListener('click', async () => {
                          li.textContent = `${guessObj.name} second guess is ${userGuesses[1]}. `;
                          if (userGuesses[1].toLowerCase() === actualGiver.toLowerCase()) {
                              // Second guess correct
                              await handleCorrectGuess(li, guessObj, userGuesses[1], 20);
                          } else {
                              li.textContent += `This is also incorrect. `;
                              if (userGuesses[2]) {
                                  const revealThirdBtn = document.createElement('button');
                                  revealThirdBtn.textContent = 'Reveal Third Guess';
                                  revealThirdBtn.style.marginLeft = '0.5rem';
                                  revealThirdBtn.addEventListener('click', async () => {
                                      li.textContent = `${guessObj.name} third guess is ${userGuesses[2]}. `;
                                      if (userGuesses[2].toLowerCase() === actualGiver.toLowerCase()) {
                                          await handleCorrectGuess(li, guessObj, userGuesses[2], 10);
                                      } else {
                                          li.textContent += `Still incorrect. `;
                                          const revealActualBtn = document.createElement('button');
                                          revealActualBtn.textContent = 'Reveal Actual Giver';
                                          revealActualBtn.style.marginLeft = '0.5rem';
                                          revealActualBtn.addEventListener('click', async () => {
                                              li.textContent = `${guessObj.name} did not guess correctly. The actual giver was ${actualGiver}.`;
                                              await updateScoresStorage();
                                          });
                                          li.appendChild(revealActualBtn);
                                      }
                                  });
                                  li.appendChild(revealThirdBtn);
                              } else {
                                  // No third guess
                                  const revealActualBtn = document.createElement('button');
                                  revealActualBtn.textContent = 'Reveal Actual Giver';
                                  revealActualBtn.style.marginLeft = '0.5rem';
                                  revealActualBtn.addEventListener('click', async () => {
                                      li.textContent = `${guessObj.name} did not guess correctly. The actual giver was ${actualGiver}.`;
                                      await updateScoresStorage();
                                  });
                                  li.appendChild(revealActualBtn);
                              }
                          }
                      });
                      li.appendChild(revealSecondBtn);
                  } else {
                      // No second guess
                      const revealActualBtn = document.createElement('button');
                      revealActualBtn.textContent = 'Reveal Actual Giver';
                      revealActualBtn.style.marginLeft = '0.5rem';
                      revealActualBtn.addEventListener('click', async () => {
                          li.textContent = `${guessObj.name} did not guess correctly. The actual giver was ${actualGiver}.`;
                          await updateScoresStorage();
                      });
                      li.appendChild(revealActualBtn);
                  }
              }
              resultsList.appendChild(li);
          }

          let percentage = totalGuesses > 0 ? ((correctCount / totalGuesses) * 100).toFixed(2) : 0;
          summaryDiv.textContent = `Correct Guesses: ${correctCount}/${totalGuesses} (${percentage}%)`;
      }

      resetGameBtn.addEventListener('click', async function() {
          const guessesRef = collection(db, 'guesses');
          const giversRef = collection(db, 'givers');
          const scoresRef = collection(db, 'scores');

          const guessesSnap = await getDocs(guessesRef);
          const giversSnap = await getDocs(giversRef);
          const scoresSnap = await getDocs(scoresRef);

          for (const docSnap of guessesSnap.docs) {
              await deleteDoc(docSnap.ref);
          }
          for (const docSnap of giversSnap.docs) {
              await deleteDoc(docSnap.ref);
          }
          for (const docSnap of scoresSnap.docs) {
              await deleteDoc(docSnap.ref);
          }

          alert("Game reset. Starting over.");
          showSection(guessSection);
      });

      viewLeaderboardBtn.addEventListener('click', async function() {
          showSection(leaderboardSection);
          await displayLeaderboard();
      });

      backToResultsBtn.addEventListener('click', function() {
          showSection(resultsSection);
      });

      async function displayLeaderboard() {
          leaderboardTableBody.innerHTML = '';
          const scoresRef = collection(db, 'scores');
          const scoresSnap = await getDocs(scoresRef);
          const scoresArray = [];
          scoresSnap.forEach(docSnap => {
              scoresArray.push(docSnap.data());
          });

          // Sort by score descending
          scoresArray.sort((a,b) => b.score - a.score);

          scoresArray.forEach(player => {
              const tr = document.createElement('tr');
              const tdName = document.createElement('td');
              const tdScore = document.createElement('td');
              tdName.textContent = player.name;
              tdScore.textContent = player.score;
              tr.appendChild(tdName);
              tr.appendChild(tdScore);
              leaderboardTableBody.appendChild(tr);
          });
      }
    </script>
</body>
</html>
